<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Jogo do Bicho - Sistema de Notificação - Cadastro</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/estilos.css">
    </head>

    <body>
        <div id="formulario">
            <h2>Jogo do Bixo - Cadastro de Evento</h2>
            <form action="/notify" method="post" id="event-form">
                <div>
                    <label for="name">Nome:</label>
                    <input type="text" id="name" name="name" placeholder="Digite seu nome">
                </div>

                <div class="my-tooltip">
                    <h3>Resultado</h3>
                    <span class="my-tooltiptext">
                        Escolha o(s) sorteio(s) desejado(s).<br><br>
                        Tradicionalmente, existem pelo menos 6 sorteios diários da banca PARA TODOS no Rio de Janeiro, conhecidos como:<br>
                        <ul>
                            <li>PPT (Primeira Para Todos) - 9:30</li>
                            <li>PTM (Para Todos Matinal) - 11:30</li>
                            <li>PT (Para Todos)  - 14:30</li>
                            <li>PTV (Para Todos Vespertino) - 16:30</li>
                            <li>PTN (Para Todos Noite) - 18:30</li>
                            <li>FED* (Loteria Federal) - 19:30</li>
                            <li>COR (Corujinha/Corujão) - 21:30</li>
                        </ul>
                        <span class="observacao">*Não está incluso.</span>
                    </span>
                </div>
                <div class="grid-checkbox">
                    <div class="checkbox-container">
                        <input type="checkbox" id="PPT" name="PPT">
                        <label for="PPT">PPT</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="PTM" name="PTM">
                        <label for="PTM">PTM</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="PT" name="PT">
                        <label for="PT">PT</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="PTV" name="PTV">
                        <label for="PTV">PTV</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="PTN" name="PTN">
                        <label for="PTN">PTN</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="COR" name="COR">
                        <label for="COR">COR</label>
                    </div>
                </div>

                <div>
                    <label for="palpite">Deseja receber palpite de jogo regularmente?</label>
                    <input type="checkbox" id="palpite" name="palpite">
                </div>

                <div>
                    <label for="sonho">Deseja receber o significado de um sonho aleatório regularmente?</label>
                    <input type="checkbox" id="sonho" name="sonho">
                </div>

                <h3>Via de Notificação</h3>
                <div class="grid-checkbox">
                    <div class="checkbox-container">
                        <input type="checkbox" id="emailCheckbox" name="emailCheckbox">
                        <label for="emailCheckbox">E-mail</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="sms" name="sms">
                        <label for="sms">SMS</label>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="telegram" name="telegram">
                        <label for="telegram">Telegram</label>
                    </div>
                </div>

                <div id="input-area"></div>
    
                <button type="submit" id="btn-cadastrar">Cadastrar Evento</button>
            </form>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modalCadastroEvento" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel"></h5>
                    </div>
                    <div class="modal-body" id="descricaoModal"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn" id="btnVoltar" data-bs-dismiss="modal">Voltar</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const emailCheckbox = document.getElementById('emailCheckbox')
                const smsCheckbox = document.getElementById('sms')
                const telegramCheckbox = document.getElementById('telegram')
                const inputArea = document.getElementById('input-area')
                const phoneInput = document.getElementById('phone')

                emailCheckbox.addEventListener('change', handleEmail)
                smsCheckbox.addEventListener('change', handlePhone)
                telegramCheckbox.addEventListener('change', handlePhone)

                function handleEmail() {
                    const emailDiv = document.getElementById('email-div')
                    if(emailCheckbox.checked) {
                        if(!emailDiv) {
                            createEmailDiv()
                        }
                    } else {
                        if(emailDiv) {
                            emailDiv.remove()
                        }
                    }
                }

                function handlePhone() {
                    const phoneDiv = document.getElementById('phone-div')
                    if(smsCheckbox.checked || telegramCheckbox.checked) {
                        if(!phoneDiv) {
                            createPhoneDiv()
                        }
                    } else {
                        if(phoneDiv && !smsCheckbox.checked && !telegramCheckbox.checked) {
                            phoneDiv.remove()
                        }
                    }
                }

                function createEmailDiv() {
                    const emailDiv = document.createElement('div')
                    emailDiv.id = 'email-div'
                    inputArea.appendChild(emailDiv)

                    const emailLabel = document.createElement('label')
                    emailLabel.htmlFor = 'email'
                    emailLabel.style = 'width: 90px;'
                    emailLabel.innerText = 'E-mail:'
                    emailDiv.appendChild(emailLabel)

                    const emailInput = document.createElement('input')
                    emailInput.type = 'email'
                    emailInput.id = 'email'
                    emailInput.name = 'email'
                    emailInput.placeholder = 'Digite seu e-mail'
                    emailDiv.appendChild(emailInput)
                }

                function createPhoneDiv() {
                    const phoneDiv = document.createElement('div')
                    phoneDiv.id = 'phone-div'
                    inputArea.appendChild(phoneDiv)

                    const phoneLabel = document.createElement('label')
                    phoneLabel.htmlFor= 'phone'
                    phoneLabel.innerText = 'Telefone:'
                    phoneDiv.appendChild(phoneLabel)

                    const phoneInput = document.createElement('input')
                    phoneInput.type = 'tel'
                    phoneInput.id = 'phone'
                    phoneInput.name = 'phone'
                    phoneInput.placeholder = '(xx) 9xxxx-xxxx'
                    phoneInput.pattern = '\\(\\d{2}\\)\\s9\\d{4}-\\d{4}'
                    phoneDiv.appendChild(phoneInput)
                }
                    
                // Código modificado do input do telefone retirado de: https://codepen.io/taimoorsattar/pen/vYRJExq
                document.addEventListener('input', function (e) {
                    if(e.target && e.target.id === 'phone') {
                        let cursorPos = e.target.selectionStart
                        let formatInput = autoFormatPhoneNumber(e.target)
                        e.target.value = String(formatInput)
                        let isBackspace = (e?.data==null) ? true: false
                        let nextCusPos = nextDigit(formatInput, cursorPos, isBackspace)
                        
                        phone.setSelectionRange(nextCusPos+1, nextCusPos+1)
                    }
                })

                function nextDigit(input, cursorpos, isBackspace) {
                    if(isBackspace) {
                        for (let i = cursorpos-1; i > 0; i--) {
                            if(/\d/.test(input[i])) {
                                return i
                            }
                    }
                    } else {
                        for (let i = cursorpos-1; i < input.length; i++) {
                            if(/\d/.test(input[i])) {
                                return i
                            }
                        }
                    }
                    
                    return cursorpos
                }

                function autoFormatPhoneNumber(ref) {
                    try {
                        let phoneNumberString = ref.value
                        var cleaned = ("" + phoneNumberString).replace(/\D/g, "")
                        var match = cleaned.match(/^(\d{0,2})?(\d{0,5})?(\d{0,4})?/)
                        return [match[1] ? "(": "",
                                match[1], 
                                match[2] ? ") ": "",
                                match[2],
                                match[3] ? "-": "",
                                match[3]].join("")
                        
                    } catch(err) {
                        return ""
                    }
                }

                document.getElementById('event-form').addEventListener('submit', function(event) {
                    event.preventDefault()
                    
                    var formData = new FormData(this)
    
                    fetch('/notify', {
                        method: 'POST',
                        body: new URLSearchParams(formData).toString(),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success === 'true') {
                            document.getElementById('exampleModalLabel').innerText = 'Cadastro Realizado com Sucesso'
                            document.getElementById('descricaoModal').innerHTML = `<p>${data.message}</p>`
                            document.getElementsByClassName('modal-header')[0].className = 'modal-header text-success'
                            document.getElementById('btnVoltar').className = 'btn btn-success'
    
                            var myModal = new bootstrap.Modal(document.getElementById('modalCadastroEvento'))
                            myModal.show()
                        } else {
                            document.getElementById('exampleModalLabel').innerText = 'Erro no Cadastro'
                            document.getElementById('descricaoModal').innerHTML = `<p>${data.message}</p>`
                            document.getElementsByClassName('modal-header')[0].className = 'modal-header text-danger'
                            document.getElementById('btnVoltar').className = 'btn btn-danger'
    
                            var myModal = new bootstrap.Modal(document.getElementById('modalCadastroEvento'))
                            myModal.show()
                        }
                    })
                })
            })
        </script>
    </body>
</html>